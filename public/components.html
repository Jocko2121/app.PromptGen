<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Components Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
            margin-bottom: 20px;
        }
        .component-group {
            margin-bottom: 40px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        th, td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
            font-size: 0.97em;
            word-break: break-word;
            white-space: normal;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            white-space: nowrap;
        }
        td:not(:nth-child(4)) { /* All except Prompt Value */
            font-size: 0.95em;
            white-space: nowrap;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 4px;
            margin: 10px 0;
        }
        .group-title {
            margin-top: 40px;
            margin-bottom: 10px;
            font-size: 1.3em;
            color: #2a2a2a;
        }
        .tier2-col {
            display: none;
        }
        .show-tier2 .tier2-col {
            display: table-cell;
        }
        .tier2-details-row {
            background: #f6f6fa;
        }
        .tier2-details-box {
            font-size: 0.97em;
            color: #444;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .pc_group-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .pc_group-title-label {
            display: flex;
            align-items: center;
        }
        .pc_add-prompt-btn {
            opacity: 0.6;
            cursor: not-allowed;
            padding: 4px 14px;
            border-radius: 4px;
            border: 1px solid #d0d0d0;
            background: #f5f5f5;
            color: #888;
            font-size: 0.97em;
            margin-left: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin-bottom: 0;">Prompt Components Admin</h1>
            <button id="save-all-btn" disabled style="opacity:0.6;cursor:not-allowed;padding:8px 22px;border-radius:4px;border:1px solid #d0d0d0;background:#f5f5f5;color:#888;font-size:1em;">Save All</button>
        </div>
        <div id="error-message" class="error" style="display: none;"></div>
        <button id="toggle-details-btn" style="margin-bottom: 20px;">Show Details</button>
        <div id="components-grouped-view"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let showTier2 = false;
            const toggleBtn = document.getElementById('toggle-details-btn');
            const groupedView = document.getElementById('components-grouped-view');

            toggleBtn.addEventListener('click', () => {
                showTier2 = !showTier2;
                toggleBtn.textContent = showTier2 ? 'Hide Details' : 'Show Details';
                document.querySelectorAll('.tier2-details-row').forEach(row => {
                    row.style.display = showTier2 ? '' : 'none';
                });
            });

            try {
                // Fetch all components
                const response = await fetch('/api/user-components');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const components = await response.json();

                // Group components by component_type
                const grouped = {};
                components.forEach(component => {
                    const type = component.component_type;
                    if (!grouped[type]) grouped[type] = [];
                    grouped[type].push(component);
                });

                // Sort group keys alphabetically
                const groupKeys = Object.keys(grouped).sort();

                groupedView.innerHTML = '';

                groupKeys.forEach(type => {
                    const groupSection = document.createElement('div');
                    groupSection.className = 'component-group';

                    const groupTitleRow = document.createElement('div');
                    groupTitleRow.className = 'pc_group-title-row';

                    const groupTitle = document.createElement('span');
                    groupTitle.className = 'pc_group-title-label';
                    groupTitle.innerHTML = `
                        <input type="checkbox" disabled style="margin-right:8px;vertical-align:middle;">
                        <span style="vertical-align:middle;">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    `;

                    const addPromptBtn = document.createElement('button');
                    addPromptBtn.textContent = 'Add Prompt';
                    addPromptBtn.disabled = true;
                    addPromptBtn.className = 'pc_add-prompt-btn';

                    groupTitleRow.appendChild(groupTitle);
                    groupTitleRow.appendChild(addPromptBtn);

                    const groupTitleContainer = document.createElement('h2');
                    groupTitleContainer.className = 'group-title';
                    groupTitleContainer.style.marginBottom = '0.5em';
                    groupTitleContainer.appendChild(groupTitleRow);
                    groupSection.appendChild(groupTitleContainer);

                    // Table for subcomponents
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th style="width:5%">Active</th>
                            <th style="width:20%">Selection</th>
                            <th style="width:75%">Prompt Value</th>
                        </tr>
                    `;
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    // Sort by created_at descending
                    grouped[type].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    grouped[type].forEach(component => {
                        // Main row (Tier 1)
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="width:5%"><input type="checkbox" disabled ${component.is_active ? 'checked' : ''}></td>
                            <td style="width:20%"><input type="text" value="${component.selection || ''}" style="width:100%;box-sizing:border-box;padding:2px 4px;border:1px solid #d0d0d0;border-radius:3px;background:#fafbfc;"></td>
                            <td style="width:75%; word-break: break-word; white-space: normal;"><textarea style="width:100%;box-sizing:border-box;resize:vertical;min-height:2.2em;padding:2px 4px;border:1px solid #d0d0d0;border-radius:3px;background:#fafbfc;">${component.prompt_value || ''}</textarea></td>
                        `;
                        tbody.appendChild(row);

                        // Details row for Tier 2
                        const detailsRow = document.createElement('tr');
                        detailsRow.className = 'tier2-details-row';
                        detailsRow.style.display = 'none';
                        const detailsCell = document.createElement('td');
                        detailsCell.colSpan = 3;
                        detailsCell.innerHTML = `
                            <div class="tier2-details-box">
                                <strong>ID:</strong> ${component.id} &nbsp;|
                                <strong>User Value:</strong> ${component.user_value || ''} &nbsp;|
                                <strong>Created At:</strong> ${new Date(component.created_at).toLocaleString()} &nbsp;|
                                <strong>Modified At:</strong> ${new Date(component.modified_at).toLocaleString()} &nbsp;|
                                <strong>Is Starter:</strong> ${component.is_starter ? 'Yes' : 'No'}
                            </div>
                        `;
                        detailsRow.appendChild(detailsCell);
                        tbody.appendChild(detailsRow);
                    });

                    table.appendChild(tbody);
                    groupSection.appendChild(table);
                    groupedView.appendChild(groupSection);
                });
            } catch (error) {
                console.error('Error fetching components:', error);
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = 'An error occurred while fetching components. Please try again later.';
                errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>