<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Generator - V2</title>
    <link rel="stylesheet" href="/styles/main.css">
    
    <!-- Database Viewer iframe styles -->
    <style>
        .database-viewer-iframe {
            width: 100%;
            height: 1500px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
            overflow: auto;
            min-height: 400px;
        }
    </style>
</head>
<body class="light-mode">

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <h2>Prompt Gen</h2>
            </div>
            <div class="sidebar__content">
                <h4 class="sidebar__sub-heading">Prompt Sets ‚è≥</h4>
                <div id="prompt-sets-list" class="sidebar__list">
                </div>
                
                <h4 class="sidebar__sub-heading">Projects</h4>
                <ul id="library-list" class="sidebar__list">
                </ul>
            </div>
            <div class="sidebar__footer">
                <button id="admin-reset-button" data-action="adminReset">Admin: Hard Reset</button>
            </div>
        </aside>

        <div class="app-bar">
            <div class="app-bar__section app-bar__project">
                <span class="sidebar__hamburger" id="hamburger-button">&#9776;</span>
                <label for="project-name-input" class="project-hub__label">Project:</label>
                <input type="text" id="project-name-input" class="panel__title-input project-hub__input" data-action="projectTitleInput" placeholder="Enter project name...">
                <div class="panel__header-buttons">
                    <button id="save-project-button" class="btn btn--primary" data-action="saveProject" title="Save Project" aria-label="Save Project">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 21a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2H5zm7-14a4 4 0 1 0 0 8 4 4 0 0 0 0-8zM6 5v4h10V5H6z"/></svg>
                    </button>
                    <button id="save-as-project-button" class="btn btn--primary" data-action="saveAsProject" title="Save as New Project" aria-label="Save as New Project">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 9h-3v3H8v-3H5v-2h3V6h2v3h3v2z"/></svg>
                    </button>
                </div>
            </div>
            <div class="app-bar__section app-bar__tools"></div>
            <div class="app-bar__section app-bar__settings"></div>
        </div>

        <div class="main-content-wrapper">
            <div class="tab-bar" id="main-tab-bar">
                <div class="tab-bar__tabs">
                    <button class="tab-button active" data-tab-target="#prompt-builder-panel" data-action="switchTab">Prompt Builder</button>
                    <button class="tab-button" data-tab-target="#refinement-panel" data-action="switchTab">Refinement</button>
                    <button class="tab-button" data-tab-target="#text-transformer-panel" data-action="switchTab">Text Transformer</button>
                    <button class="tab-button" data-tab-target="#article-workspace-panel" data-action="switchTab">Article Workspace</button>
                    <!-- <button class="tab-button" data-tab-target="#settings-panel">Settings</button> -->
                </div>
                <div class="tab-bar__icons">
                    <button class="tab-button tab-button--icon" data-tab-target="#database-components-panel" data-action="switchTab" title="Database Components">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4s8-1.79 8-4s-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4"/>
                        </svg>
                    </button>
                    <button class="tab-button tab-button--icon" data-tab-target="#database-viewer-panel" data-action="switchTab" title="Database Viewer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h10v2H7V7zm0 4h10v2H7v-2zm0 4h7v2H7v-2z"/>
                        </svg>
                    </button>
                    <button class="tab-button tab-button--icon" data-tab-target="#settings-panel" data-action="switchTab" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <main class="main-content">
                <section class="panel collapsible-panel tab-content active" id="prompt-builder-panel">
                    <div class="panel__header">
                        <h3>[set_name] ‚è≥</h3>
                        <div class="panel__header-buttons">
                             <button id="add-component-button" class="btn" data-action="addComponent">Add Component</button>
                        </div>
                        <span class="collapsible-panel__icon" data-action="togglePanel">&#9660;</span>
                    </div>
                    <div class="collapsible-panel__content">
                        <div class="collapsible-panel__inner-wrapper">
                            <div class="prompt-builder__pallet" id="prompt-builder-pallet">
                                </div>
                            <div class="prompt-assembler__output">
                                                            <div class="generate-button-container">
                                <button id="assemble-all-button" class="btn btn--primary" data-action="assembleAll">Add All to Final Prompt</button>
                            </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="panel collapsible-panel tab-content" id="database-components-panel">
                    <div class="panel__header">
                        <h3>Database Components üåê ‚òπ</h3>
                        <div style="display: flex; gap: 10px; align-items: center; margin-right: 20px;">
                            <button id="toggle-details-btn" class="btn" data-action="toggleAdminDetails">Show Details</button>
                            <button id="save-all-btn" disabled class="btn">Save All</button>
                        </div>
                        <span class="collapsible-panel__icon" data-action="togglePanel">&#9660;</span>
                    </div>
                    <div class="collapsible-panel__content">
                        <div class="collapsible-panel__inner-wrapper components-admin">
                            <div id="error-message" class="error error__message"></div>
                            <div id="components-grouped-view"></div>
                        </div>
                    </div>
                </section>

                <section class="panel collapsible-panel tab-content" id="database-viewer-panel">
                    <div class="panel__header">
                        <h3>Database Viewer ‚è≥</h3>
                        <span class="collapsible-panel__icon" data-action="togglePanel">&#9660;</span>
                    </div>
                    <div class="collapsible-panel__content">
                        <div class="collapsible-panel__inner-wrapper">
                            <iframe src="/db-viewer/" class="database-viewer-iframe"></iframe>
                        </div>
                    </div>
                </section>

                <section class="panel collapsible-panel tab-content" id="refinement-panel">
                     <div class="panel__header">
                        <h3>Refinement ‚è≥</h3>
                         <span class="collapsible-panel__icon" data-action="togglePanel">&#9660;</span>
                    </div>
                     <div class="collapsible-panel__content">
                        <div class="collapsible-panel__inner-wrapper">
                            <div class="refinement-area">
                                <div class="panel user-outline-panel">
                                    <div class="panel__header"><h3>User Outline ‚è≥</h3></div>
                                    <textarea id="userOutline-textarea" autocomplete="off" placeholder="Write your outline or dump your thoughts here..." data-action="contentBlockInput"></textarea>
                                    <div class="draft-controls" data-content-block="userOutline"> ‚è≥<select class="draft-controls__select" data-action="draftSelect"></select><button class="btn btn--draft-save" data-action="draftSave">Save</button><button class="btn btn--draft-delete" data-action="draftDelete">üóëÔ∏è</button></div>
                                </div>
                                <div class="insert-button-container">
                                    <button id="insert-button" class="btn btn--primary" title="Insert Outline into Final Prompt" data-action="insertOutline">&rarr;</button>
                                </div>
                                <div class="panel final-prompt-panel">
                                    <div class="panel__header">
                                        <h3>Final Prompt ‚è≥</h3>
                                        <div class="panel__header-buttons">
                                                                        <button id="copy-button" class="btn" data-action="copyToClipboard">Copy</button>
                            <button id="clear-button" class="btn" data-action="clearContent">Clear</button>
                                        </div>
                                    </div>
                                    <textarea id="finalPrompt-textarea" autocomplete="off" placeholder="The final, combined prompt will appear here..." data-action="contentBlockInput"></textarea>
                                    <div class="draft-controls" data-content-block="finalPrompt"> ‚è≥<select class="draft-controls__select" data-action="draftSelect"></select><button class="btn btn--draft-save" data-action="draftSave">Save</button><button class="btn btn--draft-delete" data-action="draftDelete">üóëÔ∏è</button></div>
                                </div>
                            </div>
                        </div>
                     </div>
                </section>

                <section class="panel collapsible-panel tab-content" id="text-transformer-panel">
                    <div class="panel__header">
                        <h3>Text Transformer ‚è≥</h3>
                        <span class="collapsible-panel__icon" data-action="togglePanel">&#9660;</span>
                    </div>
                    <div class="collapsible-panel__content">
                        <div class="collapsible-panel__inner-wrapper">
                            <div id="action-engine-panel-content">
                                <div class="text-transformer__area">
                                    <div class="panel">
                                        <div class="panel__header"><h3>Input ‚è≥</h3></div>
                                        <textarea id="textTransformerInput-textarea" autocomplete="off" placeholder="Paste text here to transform it..." data-action="contentBlockInput"></textarea>
                                        <div class="draft-controls" data-content-block="textTransformerInput"> ‚è≥<select class="draft-controls__select" data-action="draftSelect"></select><button class="btn btn--draft-save" data-action="draftSave">Save</button><button class="btn btn--draft-delete" data-action="draftDelete">üóëÔ∏è</button></div>
                                    </div>
                                    <div class="text-transformer__actions-container">
                                                                <button class="btn btn--transformer-action" data-action="selectTextTransformerAction" data-transformer-action="summarize">Summarize</button>
                        <button class="btn btn--transformer-action" data-action="selectTextTransformerAction" data-transformer-action="rewrite">Rewrite</button>
                        <button class="btn btn--transformer-action" data-action="selectTextTransformerAction" data-transformer-action="analyze">Analyze</button>

                                        <div id="text-transformer-options-container"></div>

                                        <button id="transform-execute-button" class="btn btn--primary" data-action="executeTextTransform">Transform</button>
                                        <hr class="text-transformer__divider">
                                        <button class="btn text-transformer__action-button" data-action="copyUp" title="Copy Output to Input">‚Üë</button>
                                    </div>
                                    <div class="panel">
                                        <div class="panel__header"><h3>Output ‚è≥</h3></div>
                                        <textarea id="textTransformerOutput-textarea" autocomplete="off" placeholder="Transformed text will appear here..." data-action="contentBlockInput"></textarea>
                                        <div class="draft-controls" data-content-block="textTransformerOutput"> ‚è≥<select class="draft-controls__select" data-action="draftSelect"></select><button class="btn btn--draft-save" data-action="draftSave">Save</button><button class="btn btn--draft-delete" data-action="draftDelete">üóëÔ∏è</button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="panel collapsible-panel tab-content" id="article-workspace-panel">
                    <div class="panel__header">
                        <h3>Article Workspace ‚è≥</h3>
                        <span class="collapsible-panel__icon" data-action="togglePanel">&#9660;</span>
                    </div>
                    <div class="collapsible-panel__content">
                        <div class="collapsible-panel__inner-wrapper">
                            <textarea id="articleWorkspace-textarea" autocomplete="off" placeholder="Paste the final draft created by the LLM here..." data-action="contentBlockInput"></textarea>
                            <div class="draft-controls" data-content-block="articleWorkspace"> ‚è≥<select class="draft-controls__select" data-action="draftSelect"></select><button class="btn btn--draft-save" data-action="draftSave">Save</button><button class="btn btn--draft-delete" data-action="draftDelete">üóëÔ∏è</button></div>
                        </div>
                    </div>
                </section>
                
                <section class="panel tab-content" id="settings-panel">
                    <div class="panel__header">
                        <h3>Settings üåê</h3>
                    </div>
                    <div class="settings-panel__content">
                        <div class="settings-group">
                            <h4>Theme üåê</h4>
                            <div class="settings-group__control">
                                                            <button id="theme-light-button" class="btn btn--icon hidden">‚òÄÔ∏è</button>
                            <button id="theme-dark-button" class="btn btn--icon">üåô</button>
                            </div>
                        </div>
                        <div class="settings-group">
                            <h4>Database</h4>
                            <div class="settings-group__control">
                                <a href="/db-viewer/" target="_blank" class="btn">Open Database Viewer</a>
                            </div>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /*
            * == AI PROMPT GENERATOR V2 - ARCHITECTURE BRIEFING ==
            *
            * GUIDING PRINCIPLES:
            * - The application is a state-driven, single-page app. All UI is rendered from the 'appState' object.
            * - The core data model is a "Project," which contains all settings and content drafts. A "Project" is represented by the 'activeProject' object within the main 'appState'.
            * - All data saving/loading (Drafts and Projects) is IN-MEMORY for this wireframe. No persistent storage is used. Reloading the page will reset everything.
            */

            // --- UI-ONLY EVENT LISTENERS ---
            function setupUIEventListeners() {
                const hamburgerButton = document.getElementById('hamburger-button');
                const sidebar = document.getElementById('sidebar');
                const lightThemeButton = document.getElementById('theme-light-button');
                const darkThemeButton = document.getElementById('theme-dark-button');
                const body = document.body;
                const dbToggleButton = document.getElementById('toggle-database-section');
                const dbPanel = document.getElementById('database-components-panel');

                if (hamburgerButton && sidebar) {
                    hamburgerButton.addEventListener('click', () => {
                        sidebar.classList.toggle('sidebar--collapsed');
                    });
                }

                if(lightThemeButton && darkThemeButton && body) {
                    lightThemeButton.addEventListener('click', () => {
                        body.classList.add('light-mode');
                        lightThemeButton.classList.add('hidden');
                        darkThemeButton.classList.remove('hidden');
                    });
                    darkThemeButton.addEventListener('click', () => {
                        body.classList.remove('light-mode');
                        darkThemeButton.classList.add('hidden');
                        lightThemeButton.classList.remove('hidden');
                    });
                }

                if (dbToggleButton && dbPanel) {
                    dbToggleButton.addEventListener('click', () => {
                        const isVisible = dbPanel.style.display !== 'none';
                        dbPanel.style.display = isVisible ? 'none' : '';
                        // Using new btn system
                        dbToggleButton.classList.toggle('btn--primary', !isVisible);
                        dbToggleButton.classList.toggle('btn', isVisible);
                    });
                }
            }


            // --- DATA MODELS (CONSTANTS) ---
            // ACTIVE: builderComponentData is populated from database and used for UI dropdowns & component renaming
            let builderComponentData = {};

            // --- APPLICATION STATE (UI & TEMPORARY STATE ONLY) ---
            function getDefaultAppState() {
                return {
                    // === DATABASE-BACKED STATE (CACHED) ===
                    currentProjectId: 1,
                    currentProjectName: 'Default Project',
                    availableProjects: [],
                    activePromptSet: 'custom_build',
                    
                    // === UI-ONLY STATE ===
                    ui: {
                        expandedPanels: {},
                        selectedTabs: {},
                        unsavedChanges: false,
                        lastSaveTime: null
                    },
                    
                    // === TEMPORARY INPUT STATE ===
                    tempInput: {
                        projectName: '',
                        textareaValues: {}, // Temporary text being typed
                        componentEdits: {}   // Unsaved component changes
                    },
                    
                    // === CACHED DATA (TO AVOID API CALLS) ===
                    cache: {
                        components: [],
                        componentTypes: [],
                        promptSets: [],
                        visibility: [],
                        contentBlocks: {},
                        settings: {},
                        lastRefresh: null
                    },
                    
                    // === WORKSPACE STATE & COMPATIBILITY LAYER ===
                    // Mixed usage: Some structures are core workspace state, others are legacy compatibility
                    activeProject: {
                        builder: {},              // CORE WORKSPACE STATE - Primary data structure for prompt composition
                                                 //    Used by: component selection, text editing, active/inactive states, renaming
                        components: [],          // UNUSED - Legacy database cache structure  
                        promptSets: [],          // MINIMAL USE - Only used during component type renaming operations
                        visibility: [],          // UNUSED - Legacy visibility cache structure
                        contentBlocks: {},       // UNUSED - Legacy content management (wireframe only)
                        textTransformer: {       // UNUSED - Legacy text transformer state (wireframe only)
                            activeAction: 'analyze',
                            actions: {
                                summarize: {},
                                rewrite: {
                                    activeOption: 'casual',
                                    options: {
                                        professional: 'Rewrite in a professional tone.',
                                        casual: 'Rewrite in a casual tone.',
                                        empathetic: 'Rewrite with more empathy.'
                                    }
                                },
                                analyze: {
                                    activeOption: 'proofread',
                                    options: {
                                        proofread: 'Proofread for grammar & spelling.',
                                        identify_themes: 'Identify the main themes.',
                                        fact_check: 'Fact-check for accuracy.'
                                    }
                                }
                            }
                        }
                    }
                };
            }

            let appState = {
                // === DATABASE CACHE LAYER ===
                // Fresh data fetched from API endpoints, used to populate UI components
                cache: {
                    components: [],      // Project components from /api/components
                    promptSets: [],      // Available prompt sets from database
                    visibility: [],      // Component visibility settings per prompt set
                    contentBlocks: [],   // UNUSED - Content blocks handled differently
                    drafts: [],          // UNUSED - Drafts handled differently  
                    settings: {}         // UNUSED - Settings handled differently
                },
                
                // === PROJECT CONTEXT ===
                // Tracks which project is currently active and loaded
                currentProjectId: 1,     // Active project ID (1 = Default Project)
                currentProjectName: '',  // Display name of active project
                projects: [],            // Full project list from /api/projects
                
                // === UI STATE TRACKING ===
                // Temporary state for user interactions and unsaved changes
                unsavedChanges: false,   // UNUSED - No save system implemented yet
                tempInput: {             // UNUSED - Temporary input tracking not implemented
                    projectName: '',
                    componentContent: {},
                    contentBlocks: {}
                },
                
                // === FUNCTIONAL COMPATIBILITY LAYER ===
                // Mix of active functionality and legacy structures (see detailed comments above)
                activeProject: getDefaultAppState(),  // Contains core builder workspace state
                activePromptSet: 'basic',             // ACTIVE - Current prompt set key, used by initialization & UI updates
                builderComponentData: {},             // ACTIVE - UI lookup structure for dropdowns & component renaming
                
                // === DEPRECATED STRUCTURES ===
                // Kept to prevent breaking changes, but not actively used
                savedProjects: [],       // COMPLETELY UNUSED - No handlers implemented, docs reference legacy design
                availableProjects: []    // MINIMAL USE - Backward compatibility alias, set but never read
            };

            // --- RENDER FUNCTIONS --- 
            // ELIMINATED: All render() functions and calls removed from main app 
            // Replaced with direct database-to-DOM initialization pattern

            // --- DATABASE-TO-DOM INITIALIZATION ---
            async function initializePromptSetsFromDatabase() {
                try {
                    const response = await fetch('/api/components');
                    const data = await response.json();
                    
                    const promptSetsContainer = document.getElementById('prompt-sets-list');
                    if (!promptSetsContainer) return;
                    
                    promptSetsContainer.innerHTML = '';
                    
                    if (data.promptSets) {
                        data.promptSets.forEach(set => {
                            const div = document.createElement('div');
                            div.className = 'prompt-set-selector';
                            div.dataset.promptSetKey = set.set_key;
                            div.setAttribute('data-action', 'changePromptSet');
                            div.textContent = set.display_name;
                            
                            // Mark first one as active by default
                            if (set.is_active) {
                                div.classList.add('active');
                                appState.activePromptSet = set.set_key;
                            }
                            
                            promptSetsContainer.appendChild(div);
                        });
                    }
                } catch (error) {
                    console.error('Error initializing prompt sets:', error);
                }
            }

            async function initializeProjectLibraryFromDatabase() {
                try {
                    console.log('üîÑ Starting Project Library initialization...');
                    
                    const response = await fetch('/api/projects');
                    console.log('üì° Projects API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üìä Projects data received:', data);
                    
                    const projects = data.projects || data;
                    console.log('üìã Projects array:', projects);
                    
                    const libraryList = document.getElementById('library-list');
                    if (!libraryList) {
                        console.error('‚ùå Could not find #library-list element');
                        return;
                    }
                    
                    console.log('üéØ Found library-list element, clearing and populating...');
                    libraryList.innerHTML = '';

                    // Add "Create New Project" button
                    const createLi = document.createElement('li');
                    createLi.className = 'project-create-button';
                    createLi.innerHTML = '<span data-action="createProject">+ Create New Project</span>';
                    createLi.style.fontStyle = 'italic';
                    createLi.style.color = 'var(--primary-color)';
                    createLi.style.cursor = 'pointer';
                    libraryList.appendChild(createLi);
                    console.log('‚ûï Added Create New Project button');

                    // Add all projects
                    if (projects && projects.length > 0) {
                        projects.forEach((project, index) => {
                            console.log(`üìÅ Adding project ${index + 1}:`, project);
                            
                            const li = document.createElement('li');
                            if (project.id === appState.currentProjectId) {
                                li.className = 'active';
                                console.log(`‚úÖ Marked project ${project.id} as active`);
                            }

                            const textSpan = document.createElement('span');
                            textSpan.textContent = project.name;
                            textSpan.style.flexGrow = '1';
                            textSpan.setAttribute('data-action', 'loadProject');

                            // Only show delete button for non-Default projects
                            if (project.id !== 1) {
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn--danger sidebar__project-delete-button';
                                deleteBtn.innerHTML = '&times;';
                                deleteBtn.dataset.projectId = project.id;
                                deleteBtn.setAttribute('data-action', 'deleteProject');
                                li.appendChild(deleteBtn);
                            }

                            li.appendChild(textSpan);
                            li.dataset.projectId = project.id;
                            libraryList.appendChild(li);
                        });
                        console.log(`‚úÖ Added ${projects.length} projects to library`);
                    } else {
                        console.warn('‚ö†Ô∏è No projects found in response');
                    }
                    
                    // Store projects in appState for future use
                    appState.projects = projects;
                    appState.availableProjects = projects; // Backward compatibility
                    
                    console.log('‚úÖ Project Library initialization completed successfully');
                    
                } catch (error) {
                    console.error('‚ùå Error initializing project library:', error);
                    
                    // Show error message in the UI
                    const libraryList = document.getElementById('library-list');
                    if (libraryList) {
                        libraryList.innerHTML = `
                            <li style="color: red; font-style: italic;">
                                Error loading projects: ${error.message}
                            </li>
                        `;
                    }
                }
            }

            async function initializeProjectHubFromDatabase() {
                try {
                    const response = await fetch(`/api/projects/${appState.currentProjectId}`);
                    const data = await response.json();
                    
                    const projectTitleInput = document.getElementById('project-name-input');
                    if (projectTitleInput && data.project) {
                        projectTitleInput.value = data.project.name;
                        appState.currentProjectName = data.project.name;
                    }
                } catch (error) {
                    console.error('Error initializing project hub:', error);
                }
            }

            async function initializePromptBuilderFromDatabase() {
                try {
                    console.log('üîÑ Loading Prompt Builder components from database...');
                    
                    const response = await fetch('/api/components');
                    const data = await response.json();
                    console.log('üìä Components data received:', data);
                    
                    const palletContainer = document.getElementById('prompt-builder-pallet');
                    if (!palletContainer) {
                        console.error('‚ùå Could not find #prompt-builder-pallet element');
                        return;
                    }
                    
                    // Store component data in appState for future use
                    appState.cache.components = data.components || [];
                    appState.cache.componentTypes = data.types || [];
                    appState.cache.promptSets = data.promptSets || [];
                    appState.cache.visibility = data.visibility || [];
                    
                    // Build builderComponentData for future compatibility
                    appState.builderComponentData = {};
                    if (data.types) {
                        data.types.forEach(type => {
                            appState.builderComponentData[type.type_key] = {
                                title: type.display_name,
                                prompts: {}
                            };
                        });
                    }
                    
                    // Populate prompts from components
                    if (data.components) {
                        data.components.forEach(component => {
                            const typeData = appState.builderComponentData[component.type_key];
                            if (typeData && component.selection && component.prompt_value) {
                                if (!typeData.prompts) typeData.prompts = {};
                                typeData.prompts[component.selection] = component.prompt_value;
                            }
                        });
                    }
                    
                    // Clear the container and build the component interface
                    palletContainer.innerHTML = '';
                    
                    // Get active components for current project (for now, show all available types)
                    const activePromptSet = appState.activePromptSet || 'custom_build';
                    console.log(`üéØ Building components for active prompt set: ${activePromptSet}`);
                    
                    // Create components based on available types
                    if (data.types && data.types.length > 0) {
                        data.types.forEach((type, index) => {
                            console.log(`üß© Creating component: ${type.display_name} (${type.type_key})`);
                            createPromptBuilderComponent(palletContainer, type, data.components, index);
                        });
                        
                        console.log(`‚úÖ Created ${data.types.length} prompt builder components`);
                    } else {
                        palletContainer.innerHTML = '<p>No component types found in database.</p>';
                        console.warn('‚ö†Ô∏è No component types found');
                    }
                    
                    console.log('‚úÖ Prompt Builder initialized successfully');
                    
                } catch (error) {
                    console.error('‚ùå Error initializing prompt builder:', error);
                    
                    const palletContainer = document.getElementById('prompt-builder-pallet');
                    if (palletContainer) {
                        palletContainer.innerHTML = `
                            <p style="color: red; font-style: italic;">
                                Error loading prompt builder: ${error.message}
                            </p>
                        `;
                    }
                }
            }

            function createPromptBuilderComponent(container, componentType, components, index) {
                // Find components of this type
                const typeComponents = components.filter(c => c.type_key === componentType.type_key);
                
                // Create the component wrapper
                const componentDiv = document.createElement('div');
                componentDiv.className = 'prompt-builder__component';
                componentDiv.dataset.componentType = componentType.type_key;
                
                // Create component header
                const header = document.createElement('div');
                header.className = 'component__header';
                
                const title = document.createElement('h4');
                title.textContent = componentType.display_name;
                title.className = 'component-title';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'component__remove-button';
                removeBtn.innerHTML = '√ó';
                removeBtn.setAttribute('data-action', 'removeComponent');
                removeBtn.dataset.componentType = componentType.type_key;
                removeBtn.title = `Remove ${componentType.display_name}`;
                
                header.appendChild(title);
                header.appendChild(removeBtn);
                
                // Create component controls
                const controls = document.createElement('div');
                controls.className = 'component__controls';
                
                // Create selection dropdown
                const select = document.createElement('select');
                select.className = 'component-select';
                select.setAttribute('data-action', 'componentSelect');
                select.dataset.componentType = componentType.type_key;
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a prompt...';
                select.appendChild(defaultOption);
                
                // Add options from components
                const uniqueSelections = new Set();
                typeComponents.forEach(component => {
                    if (component.selection && !uniqueSelections.has(component.selection)) {
                        uniqueSelections.add(component.selection);
                        const option = document.createElement('option');
                        option.value = component.selection;
                        option.textContent = component.selection;
                        select.appendChild(option);
                    }
                });
                
                // Add "Write My Own..." option
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Write My Own...';
                select.appendChild(customOption);
                
                // Create textarea for prompt content
                const textarea = document.createElement('textarea');
                textarea.className = 'component-textarea';
                textarea.placeholder = `Enter your ${componentType.display_name.toLowerCase()} prompt...`;
                textarea.rows = 4;
                textarea.setAttribute('data-action', 'componentInput');
                textarea.dataset.componentType = componentType.type_key;
                
                controls.appendChild(select);
                controls.appendChild(textarea);
                
                // Assemble the component
                componentDiv.appendChild(header);
                componentDiv.appendChild(controls);
                
                container.appendChild(componentDiv);
                
                console.log(`üé® Created component interface for: ${componentType.display_name}`);
            }

            async function initializeContentBlocksFromDatabase() {
                try {
                    // For now, just initialize empty content blocks
                    // This will be expanded when we implement the draft system
                    const contentBlockTypes = ['userOutline', 'finalPrompt', 'articleWorkspace', 'textTransformerInput', 'textTransformerOutput'];
                    
                    contentBlockTypes.forEach(blockType => {
                        const textarea = document.getElementById(`${blockType}-textarea`);
                        const draftControls = document.querySelector(`.draft-controls[data-content-block="${blockType}"]`);
                        
                        if (textarea) {
                            textarea.value = ''; // Start with empty content
                        }
                        
                        if (draftControls) {
                            const select = draftControls.querySelector('.draft-controls__select');
                            const deleteBtn = draftControls.querySelector('.btn--draft-delete');
                            
                            if (select) {
                                select.innerHTML = '<option value="draft-1">Draft 1 - New</option>';
                            }
                            
                            if (deleteBtn) {
                                deleteBtn.disabled = true; // Only one draft initially
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('Error initializing content blocks:', error);
                }
            }

            async function initializeTextTransformerFromDatabase() {
                try {
                    // Initialize text transformer with default state
                    const actionButtons = document.querySelectorAll('.btn--transformer-action');
                    const optionsContainer = document.getElementById('text-transformer-options-container');
                    
                    // Set default active action
                    actionButtons.forEach(button => {
                        button.classList.toggle('btn--active', button.dataset.transformerAction === 'analyze');
                    });
                    
                    // Set default options for analyze
                    if (optionsContainer) {
                        optionsContainer.innerHTML = `
                            <label><input type="radio" name="analyze-options" value="proofread" checked data-action="selectTextTransformerOption">Proofread for grammar & spelling.</label>
                            <label><input type="radio" name="analyze-options" value="identify_themes" data-action="selectTextTransformerOption">Identify the main themes.</label>
                            <label><input type="radio" name="analyze-options" value="fact_check" data-action="selectTextTransformerOption">Fact-check for accuracy.</label>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error initializing text transformer:', error);
                }
            }

            async function initializeDatabaseComponentsFromDatabase() {
                try {
                    const response = await fetch('/api/components');
                    const data = await response.json();
                    
                    const groupedView = document.getElementById('components-grouped-view');
                    if (!groupedView) return;
                    
                    groupedView.innerHTML = '<p>Database Components panel initialized. Admin functionality will be implemented in next phase.</p>';
                    
                    // Store data for future use
                    appState.cache.components = data.components || [];
                    appState.cache.componentTypes = data.types || [];
                    appState.cache.promptSets = data.promptSets || [];
                    appState.cache.visibility = data.visibility || [];
                    
                } catch (error) {
                    console.error('Error initializing database components:', error);
                }
            }

            // --- MASTER INITIALIZATION FUNCTION ---
            async function initializeAllTabsFromDatabase() {
                console.log('üöÄ Initializing all tabs directly from database...');
                console.log('üìä Current appState:', appState);
                
                try {
                    // Initialize each tab independently from database
                    console.log('üîÑ Starting parallel initialization of all tabs...');
                    
                    const initPromises = [
                        { name: 'Prompt Sets', fn: initializePromptSetsFromDatabase },
                        { name: 'Project Library', fn: initializeProjectLibraryFromDatabase },
                        { name: 'Project Hub', fn: initializeProjectHubFromDatabase },
                        { name: 'Prompt Builder', fn: initializePromptBuilderFromDatabase },
                        { name: 'Content Blocks', fn: initializeContentBlocksFromDatabase },
                        { name: 'Text Transformer', fn: initializeTextTransformerFromDatabase },
                        { name: 'Database Components', fn: initializeDatabaseComponentsFromDatabase }
                    ];
                    
                    // Run all initialization functions with individual error handling
                    const results = await Promise.allSettled(
                        initPromises.map(async ({ name, fn }) => {
                            console.log(`‚è≥ Initializing ${name}...`);
                            try {
                                await fn();
                                console.log(`‚úÖ ${name} initialized successfully`);
                                return { name, success: true };
                            } catch (error) {
                                console.error(`‚ùå Failed to initialize ${name}:`, error);
                                return { name, success: false, error };
                            }
                        })
                    );
                    
                    // Report results
                    const successful = results.filter(r => r.value?.success).length;
                    const failed = results.filter(r => !r.value?.success);
                    
                    console.log(`üìä Initialization Summary: ${successful}/${results.length} successful`);
                    
                    if (failed.length > 0) {
                        console.warn('‚ö†Ô∏è Failed initializations:', failed.map(f => f.value?.name || 'Unknown'));
                    }
                    
                    console.log('‚úÖ All tabs initialization process completed');
                    
                } catch (error) {
                    console.error('‚ùå Critical error during tab initialization:', error);
                }
            }

            // --- TARGETED UPDATE FUNCTIONS (Replace render() calls) ---
            function updateProjectTitleDisplay(newTitle) {
                const projectTitleInput = document.getElementById('project-name-input');
                if (projectTitleInput) {
                    projectTitleInput.value = newTitle;
                }
                appState.currentProjectName = newTitle;
            }

            async function updateProjectLibraryDisplay() {
                await initializeProjectLibraryFromDatabase();
            }

            function updatePromptSetActiveState(activeSetKey) {
                const promptSetSelectors = document.querySelectorAll('.prompt-set-selector');
                promptSetSelectors.forEach(selector => {
                    selector.classList.toggle('active', selector.dataset.promptSetKey === activeSetKey);
                });
                appState.activePromptSet = activeSetKey;
            }

            // --- EVENT HANDLER FUNCTIONS ---
            // Project & Library Management Handlers
            function handleProjectSave(target, event) {
                console.log('Project save requested');
                // REMOVAL CANDIDATE: Manual save not needed - projects auto-save to database
            }

            function handleProjectSaveAs(target, event) {
                console.log('Project save as requested');
                // REMOVAL CANDIDATE: Save-as not needed - use "Create New Project" instead
            }

            function handleProjectLoad(target, event) {
                const projectId = parseInt(target.dataset.projectId) || parseInt(target.closest('[data-project-id]')?.dataset.projectId);
                
                if (!projectId) {
                    console.error('No project ID found for load operation');
                    return;
                }
                
                console.log('Loading project:', projectId);
                loadProject(projectId);
            }

            async function loadProject(projectId) {
                try {
                    console.log(`üîÑ Loading project ${projectId}...`);
                    
                    // Update current project ID
                    appState.currentProjectId = projectId;
                    
                    // Fetch project data from API
                    const response = await fetch(`/api/projects/${projectId}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load project: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üìä Project data loaded:', data);
                    
                    // Update appState with project data
                    if (data.project) {
                        appState.currentProjectName = data.project.name;
                        console.log(`‚úÖ Switched to project: "${data.project.name}"`);
                    }
                    
                    // Update UI elements
                    await updateProjectLoadUI(projectId, data);
                    
                    console.log(`‚úÖ Project ${projectId} loaded successfully`);
                    
                } catch (error) {
                    console.error('‚ùå Error loading project:', error);
                    
                    // Show error to user
                    alert(`Failed to load project: ${error.message}`);
                }
            }

            async function updateProjectLoadUI(projectId, projectData) {
                // Update project title in Project Hub
                const projectTitleInput = document.getElementById('project-name-input');
                if (projectTitleInput && projectData.project) {
                    projectTitleInput.value = projectData.project.name;
                    console.log('üìù Updated project title input');
                }
                
                // Update active state in project library
                const libraryItems = document.querySelectorAll('#library-list li[data-project-id]');
                libraryItems.forEach(item => {
                    const itemProjectId = parseInt(item.dataset.projectId);
                    if (itemProjectId === projectId) {
                        item.classList.add('active');
                        console.log(`‚úÖ Marked project ${projectId} as active in library`);
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // Update other tabs with project-specific data
                // For now, we'll just refresh the basic initialization
                // Later we can add more sophisticated project-specific loading
                
                console.log('üéØ UI updated for project switch');
            }

            function handleProjectDelete(target, event) {
                event.stopPropagation(); // Prevent triggering project load
                
                const projectId = parseInt(target.dataset.projectId);
                
                if (!projectId) {
                    console.error('No project ID found for delete operation');
                    return;
                }
                
                // Find project name for confirmation
                const projectElement = target.closest('[data-project-id]');
                const projectName = projectElement?.querySelector('span[data-action="loadProject"]')?.textContent || `Project ${projectId}`;
                
                console.log('Delete requested for project:', projectId, projectName);
                
                // Confirm deletion
                const confirmed = confirm(`Are you sure you want to delete "${projectName}"?\n\nThis action cannot be undone.`);
                
                if (confirmed) {
                    console.log('Deletion confirmed for project:', projectId);
                    deleteProject(projectId, projectName);
                } else {
                    console.log('Deletion cancelled for project:', projectId);
                }
            }

            async function deleteProject(projectId, projectName) {
                try {
                    console.log(`üîÑ Deleting project ${projectId}: "${projectName}"...`);
                    
                    // Call API to delete project
                    const response = await fetch(`/api/projects/${projectId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to delete project: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üìä Project deletion response:', data);
                    
                    console.log(`‚úÖ Project "${projectName}" deleted successfully`);
                    
                    // If we deleted the currently active project, switch to Default Project
                    if (projectId === appState.currentProjectId) {
                        console.log('üîÑ Deleted project was active, switching to Default Project...');
                        await loadProject(1); // Switch to Default Project
                    }
                    
                    // Refresh the project library to remove the deleted project
                    await initializeProjectLibraryFromDatabase();
                    
                    console.log('üéØ Project library refreshed after deletion');
                    
                } catch (error) {
                    console.error('‚ùå Error deleting project:', error);
                    alert(`Failed to delete project: ${error.message}`);
                }
            }

            function createNewProject(target, event) {
                console.log('Create new project requested');
                
                // Prompt user for project name
                const projectName = prompt('Enter name for new project:');
                
                if (!projectName || projectName.trim() === '') {
                    console.log('Project creation cancelled - no name provided');
                    return;
                }
                
                console.log('Creating new project:', projectName.trim());
                createProject(projectName.trim());
            }

            async function createProject(projectName) {
                try {
                    console.log(`üîÑ Creating new project: "${projectName}"...`);
                    
                    // Call API to create project
                    const response = await fetch('/api/projects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: projectName,
                            description: `New project: ${projectName}`
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to create project: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üìä Project creation response:', data);
                    
                    if (data.project) {
                        console.log(`‚úÖ Project created successfully: ID ${data.project.id}`);
                        
                        // Refresh the project library to show the new project
                        await initializeProjectLibraryFromDatabase();
                        
                        // Switch to the new project
                        await loadProject(data.project.id);
                        
                        console.log(`üéØ Switched to new project: "${data.project.name}"`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error creating project:', error);
                    alert(`Failed to create project: ${error.message}`);
                }
            }

            function handleAdminReset(target, event) {
                console.log('Admin reset requested');
                // REMOVAL CANDIDATE: Admin reset never implemented - database operations handled differently
            }

            // Content Blocks & Drafts Handlers - REMOVAL CANDIDATES
            function handleDraftSave(target, event) {
                console.log('Draft save requested');
                // REMOVAL CANDIDATE: Draft system never implemented - content handled directly in textareas
            }

            function handleDraftDelete(target, event) {
                console.log('Draft delete requested');
                // REMOVAL CANDIDATE: Draft system never implemented - content handled directly in textareas
            }

            function handleDraftSelect(target, event) {
                console.log('Draft select requested:', target.value);
                // REMOVAL CANDIDATE: Draft system never implemented - content handled directly in textareas
            }

            function handleInsertOutline(target, event) {
                console.log('Insert outline requested');
                // REMOVAL CANDIDATE: Outline feature never implemented - users compose prompts manually
            }

            function handleCopyToClipboard(target, event) {
                console.log('Copy to clipboard requested');
                // REMOVAL CANDIDATE: Auto-copy never implemented - users copy manually from textareas
            }

            function handleClearContent(target, event) {
                console.log('Clear content requested');
                // REMOVAL CANDIDATE: Auto-clear never implemented - users clear textareas manually
            }

            // Text Transformer Handlers - REMOVAL CANDIDATES
            function handleTextTransformerAction(target, event) {
                console.log('Text transformer action selected:', target.dataset.transformerAction);
                // REMOVAL CANDIDATE: Text transformer never implemented - was wireframe concept only
            }

            function handleTextTransformerOption(target, event) {
                console.log('Text transformer option selected:', target.value);
                // REMOVAL CANDIDATE: Text transformer never implemented - was wireframe concept only
            }

            function handleTextTransformExecute(target, event) {
                console.log('Text transform execute requested');
                // REMOVAL CANDIDATE: Text transformer never implemented - was wireframe concept only
            }

            function handleTextCopyUp(target, event) {
                console.log('Text copy up requested');
                // REMOVAL CANDIDATE: Text transformer never implemented - was wireframe concept only
            }

            // Prompt Builder Handlers - REMOVAL CANDIDATES
            function handleAddComponent(target, event) {
                console.log('Add component requested');
                // REMOVAL CANDIDATE: Dynamic components never implemented - uses fixed database component types
            }

            function handleRemoveComponent(target, event) {
                console.log('Remove component requested');
                // REMOVAL CANDIDATE: Dynamic components never implemented - uses fixed database component types
            }

            function handleComponentSelect(target, event) {
                const componentType = target.dataset.componentType;
                const selectedValue = target.value;
                
                console.log(`üéØ Component select changed: ${componentType} = ${selectedValue}`);
                
                // Find the corresponding textarea (using correct BEM class name)
                const componentDiv = target.closest('.prompt-builder__component');
                const textarea = componentDiv?.querySelector('.component-textarea');
                
                if (!textarea) {
                    console.error('Could not find textarea for component:', componentType);
                    return;
                }
                
                if (selectedValue === 'custom') {
                    // User wants to write their own
                    textarea.value = '';
                    textarea.focus();
                    console.log(`‚úèÔ∏è Switched to custom input for ${componentType}`);
                } else if (selectedValue === '') {
                    // User selected default "Select a prompt..." option
                    textarea.value = '';
                    console.log(`üîÑ Cleared ${componentType} selection`);
                } else {
                    // User selected a predefined prompt
                    const selectedComponent = appState.cache.components.find(c => 
                        c.type_key === componentType && c.selection === selectedValue
                    );
                    
                    if (selectedComponent && selectedComponent.prompt_value) {
                        textarea.value = selectedComponent.prompt_value;
                        console.log(`üìù Loaded predefined prompt for ${componentType}: ${selectedValue}`);
                    } else {
                        console.warn(`‚ö†Ô∏è No prompt value found for ${componentType}: ${selectedValue}`);
                        textarea.value = '';
                    }
                }
                
                // Update appState to track the selection
                if (!appState.activeProject) appState.activeProject = {};
                if (!appState.activeProject.builder) appState.activeProject.builder = {};
                if (!appState.activeProject.builder[componentType]) {
                    appState.activeProject.builder[componentType] = {};
                }
                
                appState.activeProject.builder[componentType].selection = selectedValue;
                appState.activeProject.builder[componentType].promptValue = textarea.value;
                
                console.log(`üíæ Updated appState for ${componentType}:`, appState.activeProject.builder[componentType]);
            }

            function handleAssembleAll(target, event) {
                console.log('üîß Assemble all components requested');
                assembleAllComponents();
            }

            function assembleAllComponents() {
                try {
                    console.log('üîÑ Assembling all components into final prompt...');
                    
                    // Find all component textareas with content
                    const componentTextareas = document.querySelectorAll('.prompt-builder__component .component-textarea');
                    const componentParts = [];
                    
                    componentTextareas.forEach(textarea => {
                        const content = textarea.value.trim();
                        if (content) {
                            // Get the component type for labeling
                            const componentType = textarea.dataset.componentType;
                            const componentDiv = textarea.closest('.prompt-builder__component');
                            const componentTitle = componentDiv?.querySelector('.component__header h4')?.textContent || componentType;
                            
                            console.log(`üìù Found content for ${componentTitle}: ${content.substring(0, 50)}...`);
                            
                            // Add the component with a label
                            componentParts.push(`**${componentTitle}:**\n${content}`);
                        }
                    });
                    
                    if (componentParts.length === 0) {
                        console.warn('‚ö†Ô∏è No component content found to assemble');
                        alert('No component content found. Please select prompts or enter custom content in the components first.');
                        return;
                    }
                    
                    // Assemble the final prompt
                    const assembledPrompt = componentParts.join('\n\n');
                    console.log(`‚úÖ Assembled ${componentParts.length} components into final prompt`);
                    
                    // Find the final prompt textarea (in Refinement tab)
                    const finalPromptTextarea = document.getElementById('finalPrompt-textarea');
                    if (finalPromptTextarea) {
                        finalPromptTextarea.value = assembledPrompt;
                        console.log('üìã Final prompt updated in Refinement tab');
                        
                        // Show success feedback
                        showAssembleSuccess(componentParts.length);
                        
                        // Switch to Refinement tab to show the result
                        switchToRefinementTab();
                        
                    } else {
                        console.error('‚ùå Could not find finalPrompt-textarea element');
                        alert('Error: Could not find the Final Prompt textarea. Please check the Refinement tab.');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error assembling components:', error);
                    alert(`Error assembling components: ${error.message}`);
                }
            }

            function showAssembleSuccess(componentCount) {
                // Find the assemble button and show temporary success state
                const assembleButton = document.querySelector('[data-action="assembleAll"]');
                if (assembleButton) {
                    const originalText = assembleButton.textContent;
                    assembleButton.textContent = `‚úÖ Assembled ${componentCount} Components!`;
                    assembleButton.style.backgroundColor = 'var(--success-color)';
                    
                    // Reset after 2 seconds
                    setTimeout(() => {
                        assembleButton.textContent = originalText;
                        assembleButton.style.backgroundColor = '';
                    }, 2000);
                }
                
                console.log(`üéØ Successfully assembled ${componentCount} components into final prompt`);
            }

            // Database Admin Handlers - MIXED STATUS
            function handleComponentActiveToggle(target, event) {
                console.log('Component active toggle requested');
                // REMOVAL CANDIDATE: Component visibility never implemented - simplified design approach
            }

            function handleAdminToggleDetails(target, event) {
                console.log('Admin toggle details requested');
                // REMOVAL CANDIDATE: Admin details never implemented - simplified interface design
            }

            function handleComponentGroupCheckbox(target, event) {
                console.log('Component group checkbox changed:', target.checked);
                // REMOVAL CANDIDATE: Bulk operations never implemented - individual management only
            }

            function handleComponentRename(target, event) {
                console.log('Component rename requested:', target.value);
                // FUTURE FEATURE: Component type renaming planned but not yet implemented
            }

            // UI Interaction Handlers - MIXED STATUS
            function handlePanelToggle(target, event) {
                console.log('üîΩ Panel toggle requested');
                // REMOVAL CANDIDATE: Panel collapsing never implemented - simplified to tab-only navigation
            }

            function handlePromptSetChange(target, event) {
                console.log('üéØ Prompt set change requested:', target.dataset.promptSetKey);
                // FUTURE FEATURE: Prompt set switching planned but not yet implemented
            }

            function handleTabSwitch(target, event) {
                // BULLETPROOF: Only handle tab buttons with proper data attributes
                if (!target.classList.contains('tab-button') || !target.dataset.tabTarget) {
                    console.log('üö´ Not a valid tab button, ignoring');
                    return;
                }
                
                const targetPanelId = target.dataset.tabTarget.replace('#', '');
                console.log('üìë INDEPENDENT Tab Switch to panel:', targetPanelId);
                switchToPanelById(targetPanelId);
                
                // Update active tab button
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                
                // BULLETPROOF: Prevent any interference with other event systems
                event.preventDefault();
                event.stopImmediatePropagation();
            }

            function switchToPanelById(panelId) {
                try {
                    console.log(`üéØ Switching to panel: ${panelId}`);
                    
                    // Hide all tab contents using display style
                    const allTabContents = document.querySelectorAll('.tab-content');
                    allTabContents.forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });
                    
                    // Show the target tab content
                    const targetContent = document.getElementById(panelId);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                        targetContent.classList.add('active');
                        console.log(`‚úÖ Activated panel: ${panelId}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Could not find panel: ${panelId}`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error switching panels:', error);
                }
            }

            // Legacy function for backward compatibility
            function switchToTab(tabName) {
                // Map old tab names to panel IDs for backward compatibility
                const tabMapping = {
                    'prompt-builder': 'prompt-builder-panel',
                    'refinement': 'refinement-panel', 
                    'text-transformer': 'text-transformer-panel',
                    'article-workspace': 'article-workspace-panel',
                    'database-components': 'database-components-panel'
                };
                
                const panelId = tabMapping[tabName] || `${tabName}-panel`;
                switchToPanelById(panelId);
            }

            // Helper function to switch to Refinement tab after assembly
            function switchToRefinementTab() {
                switchToTab('refinement');
            }

            // Input Handlers - FUTURE FEATURES
            function handleProjectTitleInput(target, event) {
                console.log('Project title input changed:', target.value);
                // FUTURE FEATURE: Auto-save project title on input - currently manual save only
            }

            function handleContentBlockInput(target, event) {
                console.log('Content block input changed');
                // REMOVAL CANDIDATE: Content blocks never implemented - functionality moved to components
            }

            function handleComponentInput(target, event) {
                console.log('Component input changed:', target.value);
                // FUTURE FEATURE: Auto-save component text - currently uses selection-based system
            }

            // --- INDEPENDENT EVENT DELEGATION SYSTEM ---
            // Each functional area has its own independent event handler
            // This prevents interference between different parts of the app

            function setupAppEventListeners() {
                const appContainer = document.querySelector('.app-container');
                
                // === PROJECT MANAGEMENT EVENTS (Independent) ===
                appContainer.addEventListener('click', handleProjectEvents);
                
                // === PROMPT BUILDER EVENTS (Independent) ===
                appContainer.addEventListener('change', handlePromptBuilderEvents);
                appContainer.addEventListener('click', handlePromptBuilderClickEvents);
                
                // === TAB NAVIGATION EVENTS (Independent) ===
                appContainer.addEventListener('click', handleTabNavigationEvents);
                
                // === CONTENT MANAGEMENT EVENTS (Independent) ===
                appContainer.addEventListener('click', handleContentEvents);
                
                // === ADMIN PANEL EVENTS (Independent) ===
                appContainer.addEventListener('change', handleAdminEvents);
                appContainer.addEventListener('click', handleAdminClickEvents);
                
                // === TEXT TRANSFORMER EVENTS (Independent) ===
                appContainer.addEventListener('click', handleTextTransformerEvents);
                
                // === INPUT EVENTS (Independent) ===
                appContainer.addEventListener('input', handleInputEvents);
            }

            // === PROJECT MANAGEMENT EVENT HANDLER ===
            function handleProjectEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle project-related actions
                const projectActions = ['saveProject', 'saveAsProject', 'loadProject', 'deleteProject', 'createProject', 'adminReset'];
                if (!projectActions.includes(action)) return;
                
                console.log(`üèóÔ∏è Project Event: ${action}`);
                
                switch (action) {
                    case 'saveProject': handleProjectSave(target, event); break;
                    case 'saveAsProject': handleProjectSaveAs(target, event); break;
                    case 'loadProject': handleProjectLoad(target, event); break;
                    case 'deleteProject': handleProjectDelete(target, event); break;
                    case 'createProject': createNewProject(target, event); break;
                    case 'adminReset': handleAdminReset(target, event); break;
                }
                
                event.stopPropagation(); // Prevent interference with other handlers
            }

            // === PROMPT BUILDER EVENT HANDLERS ===
            function handlePromptBuilderEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle prompt builder change events
                if (action !== 'componentSelect') return;
                
                console.log(`üß© Prompt Builder Change Event: ${action}`);
                handleComponentSelect(target, event);
                event.stopPropagation();
            }

            function handlePromptBuilderClickEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle prompt builder click events
                const builderActions = ['addComponent', 'removeComponent', 'assembleAll'];
                if (!builderActions.includes(action)) return;
                
                console.log(`üß© Prompt Builder Click Event: ${action}`);
                
                switch (action) {
                    case 'addComponent': handleAddComponent(target, event); break;
                    case 'removeComponent': handleRemoveComponent(target, event); break;
                    case 'assembleAll': handleAssembleAll(target, event); break;
                }
                
                event.stopPropagation();
            }

            // === TAB NAVIGATION EVENT HANDLER ===
            function handleTabNavigationEvents(event) {
                const target = event.target;
                
                // BULLETPROOF: Only handle actual navigation tab buttons with switchTab action
                const isNavigationTab = target.classList.contains('tab-button') &&
                                       target.dataset.action === 'switchTab' &&
                                       !target.classList.contains('component__select') &&
                                       !target.closest('.component__controls');
                
                if (!isNavigationTab) return;
                
                console.log(`üìë INDEPENDENT Tab Navigation Event Detected`);
                handleTabSwitch(target, event);
                event.stopPropagation();
            }

            // === CONTENT MANAGEMENT EVENT HANDLER ===
            function handleContentEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle content-related actions
                const contentActions = ['draftSave', 'draftDelete', 'draftSelect', 'insertOutline', 'copyToClipboard', 'clearContent', 'switchTab'];
                if (!contentActions.includes(action)) return;
                
                console.log(`üìù Content Event: ${action}`);
                
                switch (action) {
                    case 'draftSave': handleDraftSave(target, event); break;
                    case 'draftDelete': handleDraftDelete(target, event); break;
                    case 'draftSelect': handleDraftSelect(target, event); break;
                    case 'insertOutline': handleInsertOutline(target, event); break;
                    case 'copyToClipboard': handleCopyToClipboard(target, event); break;
                    case 'clearContent': handleClearContent(target, event); break;
                    case 'switchTab': handleTabSwitch(target, event); break;
                }
                
                event.stopPropagation();
            }

            // === ADMIN PANEL EVENT HANDLERS ===
            function handleAdminEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle admin change events
                const adminChangeActions = ['componentGroupCheckbox', 'componentRename'];
                if (!adminChangeActions.includes(action)) return;
                
                console.log(`‚öôÔ∏è Admin Change Event: ${action}`);
                
                switch (action) {
                    case 'componentGroupCheckbox': handleComponentGroupCheckbox(target, event); break;
                    case 'componentRename': handleComponentRename(target, event); break;
                }
                
                event.stopPropagation();
            }

            function handleAdminClickEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle admin click events
                const adminClickActions = ['componentActiveToggle', 'toggleAdminDetails'];
                if (!adminClickActions.includes(action)) return;
                
                console.log(`‚öôÔ∏è Admin Click Event: ${action}`);
                
                switch (action) {
                    case 'componentActiveToggle': handleComponentActiveToggle(target, event); break;
                    case 'toggleAdminDetails': handleAdminToggleDetails(target, event); break;
                }
                
                event.stopPropagation();
            }

            // === TEXT TRANSFORMER EVENT HANDLER ===
            function handleTextTransformerEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle text transformer events
                const transformerActions = ['selectTextTransformerAction', 'selectTextTransformerOption', 'executeTextTransform', 'copyUp'];
                if (!transformerActions.includes(action)) return;
                
                console.log(`üîÑ Text Transformer Event: ${action}`);
                
                switch (action) {
                    case 'selectTextTransformerAction': handleTextTransformerAction(target, event); break;
                    case 'selectTextTransformerOption': handleTextTransformerOption(target, event); break;
                    case 'executeTextTransform': handleTextTransformExecute(target, event); break;
                    case 'copyUp': handleTextCopyUp(target, event); break;
                }
                
                event.stopPropagation();
            }

            // === INPUT EVENT HANDLER ===
            function handleInputEvents(event) {
                const target = event.target;
                const action = target.dataset.action;
                
                // Only handle input events
                const inputActions = ['projectTitleInput', 'contentBlockInput', 'componentInput'];
                if (!inputActions.includes(action)) return;
                
                console.log(`‚å®Ô∏è Input Event: ${action}`);
                
                switch (action) {
                    case 'projectTitleInput': handleProjectTitleInput(target, event); break;
                    case 'contentBlockInput': handleContentBlockInput(target, event); break;
                    case 'componentInput': handleComponentInput(target, event); break;
                }
                
                event.stopPropagation();
            }

            // --- ELIMINATED: fetchAndInitializeData function removed ---
            // Replaced with direct database-to-DOM initialization system

            function updateComponentState(key, newState) {
                const componentState = appState.activeProject.builder[key];
                const componentData = builderComponentData[key];
                if (!componentState) return;

                // Update the selection state
                Object.assign(componentState, newState);

                if (newState.selection === 'custom') {
                    // If user selects "Write My Own...", restore their saved text.
                    componentState.promptValue = componentState.userValue;
                } else {
                    // If user selects a pre-defined prompt, load it.
                    if (componentData && componentData.prompts) {
                        componentState.promptValue = componentData.prompts[newState.selection] || '';
                    }
                }
            }

            // Generic checkbox handler for all checkbox interactions
            function handleCheckboxChange(checkboxPath, value) {
                // This robustly navigates the path, creating nested objects if they don't exist.
                let target = appState;
                for (let i = 0; i < checkboxPath.length - 1; i++) {
                    const segment = checkboxPath[i];
                    if (target[segment] === undefined) {
                        // Create the missing object if it doesn't exist.
                        target[segment] = {};
                    }
                    target = target[segment];
                }

                // Set the final property
                const finalKey = checkboxPath[checkboxPath.length - 1];
                target[finalKey] = value;
                
                // Check if this change affects the current prompt set
                if (checkboxPath[0] === 'activeProject' && checkboxPath[1] === 'promptSets') {
                    const promptSetKey = checkboxPath[2];
                    const componentType = checkboxPath[3];
                    
                    // If this is the current active prompt set, update the builder
                    if (promptSetKey === appState.activeProject.activePromptSet) {
                        // For Custom Build, ensure the component exists in the builder
                        if (!appState.activeProject.builder[componentType]) {
                            appState.activeProject.builder[componentType] = { active: true, selection: 'custom', promptValue: '', userValue: '' };
                        }
                        appState.activeProject.builder[componentType].active = value;
                    }
                }
                
                // ELIMINATED: render() call removed
                // Targeted updates will be implemented as needed
            }

            // Function to update component type references in appState when renaming
            async             function handleComponentTypeRename(oldType, newType) {
                console.log('=== RENAME DEBUG ===');
                console.log('Renaming from:', oldType, 'to:', newType);
                console.log('Before update - builderComponentData:', builderComponentData);
                
                try {
                    updateComponentTypeInAppState(oldType, newType);
                    console.log('After update - builderComponentData:', builderComponentData);
                    
                    const input = document.querySelector(`[data-original-type="${oldType}"]`);
                    if (input) {
                        input.dataset.originalType = newType;
                    }
                    
                    // ELIMINATED: render() and renderComponentsAdmin() calls removed
                    console.log('Component rename completed - targeted updates will be implemented');
                    console.log('=== END RENAME DEBUG ===');
                    
                } catch (error) {
                    console.error('Error renaming component:', error);
                    const input = document.querySelector(`[data-original-type="${oldType}"]`);
                    if (input) {
                        input.value = oldType;
                    }
                }
            }

            function updateComponentTypeInAppState(oldName, newName) {
                console.log(`Updating component type from "${oldName}" to "${newName}" in appState`);
                
                // Update builder references
                if (appState.activeProject.builder[oldName]) {
                    appState.activeProject.builder[newName] = appState.activeProject.builder[oldName];
                    delete appState.activeProject.builder[oldName];
                }
                
                // Update promptActiveStates references
                if (appState.activeProject.promptActiveStates[oldName]) {
                    appState.activeProject.promptActiveStates[newName] = appState.activeProject.promptActiveStates[oldName];
                    delete appState.activeProject.promptActiveStates[oldName];
                }
                
                // Update promptSets references
                Object.keys(appState.activeProject.promptSets).forEach(promptSetKey => {
                    const promptSet = appState.activeProject.promptSets[promptSetKey];
                    if (promptSet[oldName]) {
                        promptSet[newName] = promptSet[oldName];
                        delete promptSet[oldName];
                    }
                });
                
                // Update builderComponentData references
                if (builderComponentData[oldName]) {
                    builderComponentData[newName] = builderComponentData[oldName];
                    builderComponentData[newName].title = newName.charAt(0).toUpperCase() + newName.slice(1);
                    delete builderComponentData[oldName];
                }
                
                console.log('appState updated successfully');
            }

            // --- COMPONENTS ADMIN FUNCTIONALITY ---
            // ELIMINATED: renderComponentsAdmin function removed
            // Admin panel will be initialized directly from database

            // --- INITIALIZATION ---
            setupUIEventListeners();
            setupAppEventListeners(); // Attach main app event listeners
            
            // Initialize all tabs directly from database (RENDER SYSTEM ELIMINATED)
            initializeAllTabsFromDatabase();

            // --- STATE MANAGEMENT HELPERS ---
            function clearUnsavedChanges() {
                appState.unsavedChanges = false;
                appState.tempInput = {
                    projectName: appState.currentProjectName || '',
                    componentContent: {},
                    contentBlocks: {}
                };
                console.log('üßπ Unsaved changes cleared');
            }
            
            function markUnsavedChanges() {
                appState.unsavedChanges = true;
                console.log('üìù Marked unsaved changes');
            }
            
            async function loadProjects() {
                try {
                    const response = await fetch('/api/projects');
                    if (!response.ok) {
                        throw new Error(`Failed to load projects: ${response.statusText}`);
                    }
                    
                    const responseData = await response.json();
                    const projects = responseData.projects || responseData; // Handle both response formats
                    appState.projects = projects;
                    appState.availableProjects = projects; // Backward compatibility
                    
                    // Update project selector UI if it exists
                    updateProjectSelector();
                    
                    console.log(`üìÅ Loaded ${projects?.length || 0} projects:`, projects);
                    return projects;
                    
                } catch (error) {
                    console.error('‚ùå Error loading projects:', error);
                    throw error;
                }
            }
            
            function updateProjectSelector() {
                const selector = document.getElementById('project-selector');
                if (!selector || !appState.projects) return;
                
                selector.innerHTML = '';
                appState.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    option.selected = project.id === appState.currentProjectId;
                    selector.appendChild(option);
                });
            }
        });
    </script>


</body>
</html>